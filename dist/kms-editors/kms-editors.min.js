Object.keys||(Object.keys=function(){"use strict";var n=Object.prototype.hasOwnProperty,s=!{toString:null}.propertyIsEnumerable("toString"),r=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],a=r.length;return function(t){if("object"!=typeof t&&("function"!=typeof t||null===t))throw new TypeError("Object.keys called on non-object");var e,i,o=[];for(e in t)n.call(t,e)&&o.push(e);if(s)for(i=0;i<a;i++)n.call(t,r[i])&&o.push(r[i]);return o}}()),function(t){var e="kmseditors",c=function(){},a="",v=30,g=18,u=["#111111","#0074D9","#7FDBFF","#39CCCC","#3D9970","#2ECC40","#01FF70","#FFDC00","#FF851B","#FF4136","#85144b","#F012BE","#B10DC9","#001f3f","#AAAAAA","#DDDDDD","#ffffff"],s=["系统默认","微软雅黑","黑体","宋体","新宋体","仿宋","华文行楷","楷体","方正舒体","幼圆","隶书"],m=["12px","14px","16px","18px","20px","22px","28px","36px"],h=1,l="undefined"==typeof console?{log:c,debug:c,error:c,warn:c,info:c}:console;if(l.debug||(l.debug=c),"undefined"!=typeof module&&module.exports||void 0===t[e]){var k="",b="",r=!1,w={options:{},isInit:!1,$container:"",$position:""};w.init=function(a){if(a&&0!==Object.keys(a).length){if(!this.isInit){if(!a.container)return l.warn("container 不能为空");this.isInit=!0,this.$container=$("#"+a.container),(this.options=a).debug||(window.console={log:c,debug:c,error:c,warn:c,info:c}),$(function(){$(w.$container).append('<div class="kmseditors"><div id="kmseditors-title" class="kmseditors-title"><div id="kmseditors-fullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b1"></div><p>全屏</p></div><div id="kmseditors-exitfullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b5"></div><p>退出全屏</p></div><div id="kmseditors-sketch" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b2"></div><p>热点</p></div><div id="kmseditors-uploadimg" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b4"></div><p>上传背景</p></div></div><div id="kmseditors-contant"><div id="kmseditors-contant-tips"><p>地图绘制操作指引</p><p>第一步：点击上传背景，上传制作好的地图背景</p><p>第二步：根据需求，添加热点加上关联信息</p><p>第三步：绘制完成后，点击完成，填写基本信息即可</p></div><div id="kmseditors-contextmenu"><div id="kmseditors-contextmenu-edit" title="编辑内容" class="kmseditors-contextmenu-group c3"></div><div id="kmseditors-contextmenu-size" title="字体大小" class="kmseditors-contextmenu-group c6"></div><div id="kmseditors-contextmenu-color" title="选择颜色" class="kmseditors-contextmenu-group c2"></div><div id="kmseditors-contextmenu-relation" title="关联" class="kmseditors-contextmenu-group c1"></div><div id="kmseditors-contextmenu-delete" title="删除" class="kmseditors-contextmenu-group c4"></div></div></div></div>'),function(){if(!w.options.editable){var t=$('<div id="kmseditors-sidebar"></div>');$(w.$container).append(t),$(w.$container).css("position","relative"),t.append('<ul><li class="lui_map_icon_zoom_reset mui mui-history_handler_back" title="还原" data-opt="zoomReset"></li><li class="lui_map_icon_zoom_in mui mui-addition" title="放大" data-opt="zoomIn"></li><li class="lui_map_icon_zoom_out mui mui-delete" title="缩小" data-opt="zoomOut"></li></ul>'),t.on("click",function(t){var e=$(t.target),i=e.attr("data-opt");i&&w[i]&&w[i]()})}}(),w.options.editable||$(w.$container).css({"text-align":"center"}),$("#kmseditors-contant").on("click",D);var e=$("#kmseditors-exitfullscreen");e.hide();var t,i=$("#kmseditors-fullscreen");!1===((t=document.documentElement).requestFullscreen||t.msRequestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullscreen||!1)?i.hide():(e.on("click",function(){D(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),e.hide(),i.show(),$("#kmseditors-uploadimg").show()}),i.on("click",function(){var t;D(),(t=document.documentElement).requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),i.hide(),e.show(),$("#kmseditors-uploadimg").hide()}));var o=$("#kmseditors-sketch");o.on("click",function(t){r=!0,o.find(".kmseditors-title-btngroup-icon").addClass("active")});var n=$("#kmseditors-uploadimg");n.on("click",D),function(){if("undefined"!=typeof WebUploader){var t=w.options.uploadImgUrl;if(!t)return l.error("参数uploadImgUrl 未在init方法中传入");var e=w.options.fdModelId;if(!e)return l.error("参数fdModelId 未在init方法中传入");var i=t+="&fdModelId="+e,o=i+"Uploader.swf";w.options.swfUrl&&(o=w.options.swfUrl);var n=WebUploader.create({runtimeOrder:"html5,flash",duplicate:!0,auto:!0,swf:o,server:i,pick:"#kmseditors-uploadimg",sendAsBinary:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});$(w.$container).find("#kmseditors-uploadimg").removeClass("webuploader-container"),$(w.$container).find("#kmseditors-uploadimg > div.webuploader-pick").removeClass("webuploader-pick"),n.on("beforeFileQueued",function(t){var e=$(w.$container).find("img[ref=imageMaps]");if(0<e.length&&!confirm("再次上传将会覆盖原来的背景图片，是否继续？"))return n.cancelFile(t);e.remove()}),n.on("uploadSuccess",function(t,e){var i=e.path||e._raw;if(!i)return l.error("_raw error",i);window.seajs&&seajs.use("lui/topic",function(t){t.publish("kms.editor.map.img.change",{fdAttId:e.fdAttId})});var o=w.getData(),n=o.sketchList,s=$(w.$container).find("#kmseditors-contant-sketch-warp");s&&0<s.length&&(s.remove(),w.$position.length=0);var r=w.options.host+i;p(r);var a=n.length;if(0<a)var d=setInterval(function(){if(0!==w.$position.length){clearInterval(d);var t=n.length;if(0<t)for(var e=0;e<t;e++){var i=n[e];f(i)}}},100)}),n.on("uploadError",function(t){var e=$("#"+t.id),i=e.find("div.error");i.length||(i=$('<div class="error"></div>').appendTo(e)),i.text("上传失败")})}}(),k=$("#kmseditors-contextmenu"),$(k).hide(),w.options.editable&&($(k).find("#kmseditors-contextmenu-relation").on("click",y),$(k).find("#kmseditors-contextmenu-color").on("click",I),$(k).find("#kmseditors-contextmenu-edit").on("click",function(){F(!0)}),$(k).find("#kmseditors-contextmenu-delete").on("click",z),$(k).find("#kmseditors-contextmenu-font").on("click",_),$(k).find("#kmseditors-contextmenu-size").on("click",C),function(t){for(var e='<div class="kmseditors-color-container" style="display: none">',i=0;i<t.length;i++)e+='<div class="color_div" data-color="'+t[i]+'" style="background-color:'+t[i]+";border: 2px solid "+t[i]+'"></div>';e+="</div>",$(k).append(e),$(k).find(".color_div").off("click").on("click",function(){var t=$(this).attr("data-color");$(b).find(".map-position-bg").css({color:t}),$(b).attr("data-color",t),$(k).find(".kmseditors-color-container").hide()})}(w.options.data.colors||u),function(t){for(var e='<div class="kmseditors-font-container" style="display: none">',i=0;i<t.length;i++)e+='<div class="font_div" data-font="'+t[i]+'" style="font-family:'+t[i]+'">'+t[i]+"</div>";e+="</div>",$(k).append(e),$(k).find(".font_div").off("click").on("click",function(){var t=$(this).attr("data-font");$(b).find(".map-position-bg").css({"font-family":t}),$(b).attr("data-font",t),$(k).find(".kmseditors-font-container").hide()})}(w.options.data.fonts||s),function(t){for(var e='<div class="kmseditors-size-container" style="display: none">',i=0;i<t.length;i++)e+='<div class="size_div" data-size="'+t[i]+'" style="font-size:'+t[i]+'">'+t[i]+"</div>";e+="</div>",$(k).append(e),$(k).find(".size_div").off("click").on("click",function(){console.log("啥");var t=$(this).attr("data-size");$(b).find(".map-position-bg").css({"font-size":t}),$(b).attr("data-size",t),$(k).find(".kmseditors-size-container").hide()})}(w.options.data.sizes||m))});var d=setInterval(function(){if(0!==$(w.$container).find(".kmseditors").length){var u,m;clearInterval(d),w.options.editable&&(m=u=null,$(document).on("mousemove",function(t){if(m){var e=t.pageX,i=t.pageY,o=(w.$position,e-$(u).data("pageX")),n=i-$(u).data("pageY");if(0==o&&0==n)return!1;var s=$(u).parent(),r=$(s).position(),a=r.left,d=r.top;if("map-position-bg"===m){var c=a+o;c<0&&(c=0);var l=d+n;l<0&&(l=0),s.height(),s.width(),$(s).css({left:c,top:l}),$(u).data("pageX",e),$(u).data("pageY",i)}else if("resize"===m){var c=a,l=d,f=s.height()+n,p=s.width()+o;$(s).attr("dtype"),p<v&&(p=v),f<g&&(f=g),$(s).css({width:p,height:f}),$(u).data("pageX",e),$(u).data("pageY",i)}}}),$(document).on("click","#kmseditors-contant",function(t){t.preventDefault();var e=t.target,i=e.className;if("map-position-bg"===i||"kmseditors-contextmenu-group c2"===i||"kmseditors-contextmenu-group c5"===i||"kmseditors-contextmenu-group c6"===i){var o=t.pageX,n=t.pageY;(b=-1<i.indexOf("kmseditors-contextmenu-group")?b:$(e).parent()).top=n,b.left=o,b.width=$(b).width(),b.height=$(b).height();var s=parseInt(b.attr("dtype")),r=$("#kmseditors-contextmenu-color"),a=$("#kmseditors-contextmenu-edit"),d=$("#kmseditors-contextmenu-font"),c=$("#kmseditors-contextmenu-size");0===s?(r.hide(),a.hide(),d.hide()):1===s&&(r.show(),a.show(),d.show(),c.show());var l=o,f=n,p=b[0];p&&($(p).show(),f=p.offsetTop+$(b).height(),l=p.offsetLeft+$(b).width()-$(k).width()),$(k).show().css({left:l,top:f})}else x()}),$(document).on("mousedown",".map-position-bg",function(t){w.$position.addClass("unselectable");var e=t.target;u=e,m="map-position-bg",$(e).data("pageX",t.pageX),$(e).data("pageY",t.pageY),$(e).css("cursor","move"),x()}),$(document).on("mousedown",".resize",function(t){w.$position.addClass("unselectable");var e=t.target;u=e,m="resize",$(e).data("pageX",t.pageX),$(e).data("pageY",t.pageY),x()}),$(document).on("mouseup",function(t){w.$position&&(w.$position.removeClass("unselectable"),"map-position-bg"===m&&w.$position.find(".map-position-bg").css("cursor","default"),m=u=null,$(k).hide())}));var t=a.data;if(t){var e=t.backgroundUrl,i=t.sketchList;if(e){D(),p(e);var o=setInterval(function(){if(0!==w.$position.length){clearInterval(o);var t=i.length;if(0<t)for(var e=0;e<t;e++){f(i[e])}}},10),n=0,s=0;if(!a.editable)var r=setInterval(function(){if(0<n&&0<s){clearInterval(r);var t=1;n<s&&(t=n/s),w.setZoom(t)}else n=$(w.$container).width(),s=$(w.$container).find("img[ref=imageMaps]").width()},10)}}a.editable||function(){D(),$(w.$container).find("#kmseditors-title").hide();var n=setInterval(function(){if(0!==w.$position.length){clearInterval(n);var t=$(w.$container).find("div.map-position[dtype]"),e=w.options.onRelation||c;if(t)for(var i=0;i<t.length;i++){var o=$(t[i]);o.on("click",function(){e(w.getData($(this)))}),o.find("div.map-position-bg").css({border:"none",cursor:"pointer","background-color":"transparent"}),o.find("span.resize").css({border:"none",background:"none",display:"none"})}}},50)}()}},10)}}else l.warn("请对"+e+".init()传入必要的参数")},w.getData=function(t){var e={backgroundUrl:"",sketchList:[]};function i(t){var e=t.context;return{ref:t.attr("ref"),top:t.top||e.offsetTop,left:t.left||e.offsetLeft,width:"number"==typeof t.width?t.width:e.offsetWidth,height:"number"==typeof t.height?t.height:e.offsetHeight,text:e.innerText||"",color:t.attr("data-color")||"",font:t.attr("data-font")||"",size:t.attr("data-size")||""}}var o=$(w.$container).find("img[ref=imageMaps]");if(0<o.length&&(e.backgroundUrl=o.attr("src")),void 0!==t)return e.sketchList=i(t),e;var n=this.$position;if(!n)return e;var s=n.find('.map-position[dtype="1"]');if(s.length<=0)return e;for(var r=[],a=n.width(),d=n.height(),c=0;c<s.length;c++){var l=i($(s[c])),f=l.left+l.width,p=l.top+l.height;f<a&&p<d&&r.push(l)}return e.sketchList=r,e},w.setLinkStatus=function(t){var e=t.ref,i=t.isLink;if(!e||"boolean"!=typeof i)return l.error("setLinkStatus传入参数有误");var o=$(w.$container).find('div.map-position[dtype="0"][ref="'+e+'"]');0!==!o.length&&(i?o.addClass("isLink"):o.removeClass("isLink"))},w.setZoom=function(t){var e=t||1;""===a&&(a=e),"transform"==w.options.transformType?$(w.$container).find("#kmseditors-contant-sketch-warp").css({transform:"scale("+e+")"}):$(w.$container).find("#kmseditors-contant-sketch-warp").css({zoom:e,"-moz-transform":"scale("+e+")"}),w.options.aftersetZoom&&w.options.aftersetZoom(t)},w.getZoom=function(){var t=$(w.$container).find("#kmseditors-contant-sketch-warp"),e=t[0].style.zoom;if(e&&/%$/.test(e)&&(e=parseFloat(e)/100),!e){var i=t.attr("style");if(i)for(var o=i.split(";"),n=0;n<o.length;n++){var s=o[n],r=s.indexOf("scale");if(-1===r)break;e=s.substring(r+6,s.length-1);break}}return{initZoom:a,currZoom:parseFloat(e)}},w.zoomIn=function(){var t=w.getZoom().currZoom+.1,e=2*a;e<=t&&(t=e),w.setZoom(t)},w.zoomOut=function(){var t=w.getZoom().currZoom-.1,e=.6*a;t<=e&&(t=e),w.setZoom(t)},w.zoomReset=function(){w.setZoom(a)},"undefined"!=typeof module&&"object"==typeof exports?module.exports=w:"function"==typeof define&&(define.amd||define.cmd)?define(function(){return w}):t[e]=w}else l.error(e+"已经存在啦啦啦啦~");function x(){$(k).hide().find(".kmseditors-color-container").hide(),$(k).find(".kmseditors-font-container").hide(),$(k).find(".kmseditors-size-container").hide()}function f(t){if(0!==$(w.$container).find("img[ref=imageMaps]").length){D();var e="10",i="10",o=v+80,n=g+10,s=h++,r=!1,a=u[0],d=m[0],c="",l="";t&&"object"==typeof t&&(t.top&&(e=t.top),t.left&&(i=t.left),t.width&&(o=t.width),t.height&&(n=t.height),t.ref&&(s=t.ref),t.isLink&&(r=t.isLink),t.color&&(a=t.color),t.text&&(c=t.text),t.font&&(l=t.font),t.size&&(d=t.size));var f='<div ref="'+s+'" dtype="1" data-color="'+a+'" data-font="'+l+'" data-size="'+d+'" class="map-position'+(r?" isLink":"")+'" style="top:'+e+"px;left:"+i+"px;width:"+o+"px;height:"+n+'px;"><div class="map-position-bg" style="font-size: '+d+";color:"+a+'">'+c+'</div><span class="resize"></span></div>';w.$position.append(f),t.text||(b=w.$position.find(".map-position[dtype=1]").last(),F()),$(".map-position[dtype=1]").dblclick(function(){F(!0)})}else{var p="请先上传背景！";window.seajs?seajs.use("lui/dialog",function(t){t.alert(p)}):alert(p)}}function p(t){if(t){var e=$('<div id="kmseditors-contant-sketch-warp"></div>'),i=$('<img ref="imageMaps">'),o=$('<div class="position-conrainer"></div>'),s=!1;window.seajs&&seajs.use("lui/topic",function(t){t.subscribe("/kms/kmaps/edit/canvas",function(){if(!1===s){var t=$('[ref="imageMaps"]');w.$position&&0<w.$position.length&&(w.$position.css({width:t.width(),height:t.height()}),s=!0)}})}),i.on("load",function(t){var e;w.$position=$(w.$container).find(".position-conrainer"),e=function(t){if(r){var e={top:t.pageY-72,left:t.pageX};r=!1,$("#kmseditors-sketch").find(".kmseditors-title-btngroup-icon").removeClass("active"),f(e)}},$(w.$position).off("click").on("click",e),$(w.$position).prev().off("click").on("click",e);var i=$(t.target),o=($("#kmseditors-contant"),$("#kmseditors-contant-tips"),i.width()),n=i.height();0<o&&0<n&&(s=!0),w.$position.css({top:0,left:0,width:o,height:n})}),e.append(i),e.append(o),$(w.$container).find("#kmseditors-contant").append(e),-1!==t.indexOf("?")?t+="&x=":t+="?x=",t+=(new Date).getTime(),i.attr("src",t)}}function y(){$(k).hide(),(w.options.onRelation||c)(w.getData(b))}function z(){x(),$(b).remove()}function F(t){if(w.options.editable){var e=$(b).find(".map-position-bg");$(e).attr("contenteditable",!0).focus(),t&&function(t){if(document.all)t.range=document.selection.createRange(),t.range.select(),t.range.moveStart("character",-1);else try{t.range=window.getSelection().getRangeAt(0),t.range.setStart(t.range.startContainer,t.context.innerText&&t.context.innerText.length)}catch(t){}}($(e)),$(e).on("blur",function(){$(e).attr("contenteditable",!1)}),x()}}function I(){$(k).find(".kmseditors-font-container").hide(),$(k).find(".kmseditors-size-container").hide(),$(k).find(".kmseditors-color-container").show()}function _(){$(k).find(".kmseditors-color-container").hide(),$(k).find(".kmseditors-size-container").hide(),$(k).find(".kmseditors-font-container").show()}function C(){console.log("???"),$(k).find(".kmseditors-color-container").hide(),$(k).find(".kmseditors-font-container").hide(),$(k).find(".kmseditors-size-container").show()}function D(){$(w.$container).find("#kmseditors-contant-tips").hide()}}(window);