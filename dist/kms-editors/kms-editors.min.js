Object.keys||(Object.keys=function(){"use strict";var n=Object.prototype.hasOwnProperty,s=!{toString:null}.propertyIsEnumerable("toString"),r=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],a=r.length;return function(t){if("object"!=typeof t&&("function"!=typeof t||null===t))throw new TypeError("Object.keys called on non-object");var e,i,o=[];for(e in t)n.call(t,e)&&o.push(e);if(s)for(i=0;i<a;i++)n.call(t,r[i])&&o.push(r[i]);return o}}()),function(t){var e="kmseditors",l=function(){},a="",v=30,g=15,h=160,k=30,r=["#001f3f","#0074D9","#7FDBFF","#39CCCC","#3D9970","#2ECC40","#01FF70","#FFDC00","#FF851B","#FF4136","#85144b","#F012BE","#B10DC9","#111111","#AAAAAA","#DDDDDD","#ffffff"],p=["系统默认","微软雅黑","黑体","宋体","新宋体","仿宋","华文行楷","楷体","方正舒体","幼圆","仿宋","隶书"],u=1,f="undefined"==typeof console?{log:l,debug:l,error:l,warn:l,info:l}:console;if(f.debug||(f.debug=l),"undefined"!=typeof module&&module.exports||void 0===t[e]){var b="",w="",m=!1,x={options:{},isInit:!1,$container:"",$position:""};x.init=function(d){if(d&&0!==Object.keys(d).length){if(!this.isInit){if(!d.container)return f.warn("container 不能为空");this.isInit=!0,this.$container=$("#"+d.container),(this.options=d).debug||(window.console={log:l,debug:l,error:l,warn:l,info:l}),$(function(){$(x.$container).append('<div class="kmseditors"><div id="kmseditors-title" class="kmseditors-title"><div id="kmseditors-fullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b1"></div><p>全屏</p></div><div id="kmseditors-exitfullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b5"></div><p>退出全屏</p></div><div id="kmseditors-sketch" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b2"></div><p>热点</p></div><div id="kmseditors-text" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b3"></div><p>添加文字</p></div><div id="kmseditors-uploadimg" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b4"></div><p>上传背景</p></div></div><div id="kmseditors-contant"><div id="kmseditors-contant-tips"><p>地图绘制操作指引</p><p>第一步：点击上传背景，上传制作好的地图背景</p><p>第二步：根据需求，添加热点加上关联信息</p><p>第三步：绘制完成后，点击完成，填写基本信息即可</p></div><div id="kmseditors-contextmenu"><div id="kmseditors-contextmenu-edit" title="编辑内容" class="kmseditors-contextmenu-group c3"></div><div id="kmseditors-contextmenu-font" title="更换字体" class="kmseditors-contextmenu-group c5"></div><div id="kmseditors-contextmenu-color" title="选择颜色" class="kmseditors-contextmenu-group c2"></div><div id="kmseditors-contextmenu-relation" title="关联" class="kmseditors-contextmenu-group c1"></div><div id="kmseditors-contextmenu-delete" title="删除" class="kmseditors-contextmenu-group c4"></div></div></div></div>'),function(){if(!x.options.editable){var t=$('<div id="kmseditors-sidebar"></div>');$(x.$container).append(t),$(x.$container).css("position","relative"),t.append('<ul><li class="lui_map_icon_zoom_reset mui mui-history_handler_back" title="还原" data-opt="zoomReset"></li><li class="lui_map_icon_zoom_in mui mui-addition" title="放大" data-opt="zoomIn"></li><li class="lui_map_icon_zoom_out mui mui-delete" title="缩小" data-opt="zoomOut"></li></ul>'),t.on("click",function(t){var e=$(t.target),i=e.attr("data-opt");i&&x[i]&&x[i]()})}}(),x.options.editable||$(x.$container).css({"text-align":"center"}),$("#kmseditors-contant").on("click",R);var e=$("#kmseditors-exitfullscreen");e.hide();var t,i=$("#kmseditors-fullscreen");!1===((t=document.documentElement).requestFullscreen||t.msRequestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullscreen||!1)?i.hide():(e.on("click",function(){R(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),e.hide(),i.show()}),i.on("click",function(){var t;R(),(t=document.documentElement).requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),i.hide(),e.show()}));var o=$("#kmseditors-sketch");o.on("click",function(t){z(),m=!1,$("#kmseditors-text").find(".kmseditors-title-btngroup-icon").removeClass("active")});var n=$("#kmseditors-text");n.on("click",function(t){m=!0,n.find(".kmseditors-title-btngroup-icon").addClass("active")});var s=$("#kmseditors-uploadimg");s.on("click",R),function(){if("undefined"!=typeof WebUploader){var t=x.options.uploadImgUrl;if(!t)return f.error("参数uploadImgUrl 未在init方法中传入");var e=x.options.fdModelId;if(!e)return f.error("参数fdModelId 未在init方法中传入");var i=t+="&fdModelId="+e,o=i+"Uploader.swf";x.options.swfUrl&&(o=x.options.swfUrl);var n=WebUploader.create({runtimeOrder:"html5,flash",duplicate:!0,auto:!0,swf:o,server:i,pick:"#kmseditors-uploadimg",sendAsBinary:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});$(x.$container).find("#kmseditors-uploadimg").removeClass("webuploader-container"),$(x.$container).find("#kmseditors-uploadimg > div.webuploader-pick").removeClass("webuploader-pick"),n.on("beforeFileQueued",function(t){var e=$(x.$container).find("img[ref=imageMaps]");if(0<e.length&&!confirm("再次上传将会覆盖原来的背景图片，是否继续？"))return n.cancelFile(t);e.remove()}),n.on("uploadSuccess",function(t,e){var i=e.path||e._raw;if(!i)return f.error("_raw error",i);window.seajs&&seajs.use("lui/topic",function(t){t.publish("kms.editor.map.img.change",{fdAttId:e.fdAttId})});var o=x.getData(),n=o.sketchList,s=o.textList,r=$(x.$container).find("#kmseditors-contant-sketch-warp");r&&0<r.length&&r.remove();var a=x.options.host+i;L(a);var d=n.length;0<d&&setTimeout(function(){for(var t=0;t<d;t++){var e=n[t];z(e)}},300);var c=s.length;0<c&&setTimeout(function(){for(var t=0;t<c;t++){var e=s[t];I(e)}},300)}),n.on("uploadError",function(t){var e=$("#"+t.id),i=e.find("div.error");i.length||(i=$('<div class="error"></div>').appendTo(e)),i.text("上传失败")})}}(),b=$("#kmseditors-contextmenu"),$(b).hide(),x.options.editable&&($(b).find("#kmseditors-contextmenu-relation").on("click",_),$(b).find("#kmseditors-contextmenu-color").on("click",D),$(b).find("#kmseditors-contextmenu-edit").on("click",C),$(b).find("#kmseditors-contextmenu-delete").on("click",j),$(b).find("#kmseditors-contextmenu-font").on("click",O),function(t){for(var e='<div class="kmseditors-color-container" style="display: none">',i=0;i<t.length;i++)e+='<div class="color_div" data-color="'+t[i]+'" style="background-color:'+t[i]+";border: 2px solid "+t[i]+'"></div>';e+="</div>",$(b).append(e),$(b).find(".color_div").off("click").on("click",function(){var t=$(this).attr("data-color");$(w).find(".map-position-bg").css({color:t}),$(w).attr("data-color",t),$(b).find(".kmseditors-color-container").hide()})}(x.options.data.colors||r),function(t){for(var e='<div class="kmseditors-font-container" style="display: none">',i=0;i<t.length;i++)e+='<div class="font_div" data-font="'+t[i]+'" style="font-family:'+t[i]+'">'+t[i]+"</div>";e+="</div>",$(b).append(e),$(b).find(".font_div").off("click").on("click",function(){var t=$(this).attr("data-font");$(w).find(".map-position-bg").css({fontFamily:t}),$(w).attr("data-font",t),$(b).find(".kmseditors-font-container").hide()})}(x.options.data.fonts||p))});var c=setInterval(function(){if(0!==$(x.$container).find(".kmseditors").length){var u,m;clearInterval(c),x.options.editable&&(m=u=null,$(document).on("mousemove",function(t){if(m){var e=t.pageX,i=t.pageY,o=(x.$position,e-$(u).data("pageX")),n=i-$(u).data("pageY");if(0==o&&0==n)return!1;var s=$(u).parent(),r=$(s).position(),a=r.left,d=r.top;if("map-position-bg"===m){var c=a+o;c<0&&(c=0);var l=d+n;l<0&&(l=0),s.height(),s.width(),$(s).css({left:c,top:l}),$(u).data("pageX",e),$(u).data("pageY",i)}else if("resize"===m){var c=a,l=d,p=s.height()+n,f=s.width()+o;1==$(s).attr("dtype")?(f<h&&(f=h),p<k&&(p=k)):(f<v&&(f=v),p<g&&(p=g)),$(s).css({width:f,height:p}),1==$(s).attr("dtype")&&F(s),$(u).data("pageX",e),$(u).data("pageY",i)}}}),$(document).on("click","#kmseditors-contant",function(t){t.preventDefault();var e=t.target,i=e.className;if("map-position-bg"===i||"kmseditors-contextmenu-group c2"===i||"kmseditors-contextmenu-group c5"===i){var o=t.pageX,n=t.pageY;(w=-1<i.indexOf("kmseditors-contextmenu-group")?w:$(e).parent()).top=n,w.left=o,w.width=$(w).width(),w.height=$(w).height();var s=parseInt(w.attr("dtype")),r=$("#kmseditors-contextmenu-color"),a=$("#kmseditors-contextmenu-edit"),d=$("#kmseditors-contextmenu-font");0===s?(r.hide(),a.hide(),d.hide()):1===s&&(r.show(),a.show(),d.show());var c=o,l=n,p=w[0];p&&($(p).show(),l=p.offsetTop+$(w).height(),c=p.offsetLeft+$(w).width()-$(b).width()),$(b).show().css({left:c,top:l})}else y()}),$(document).on("mousedown",".map-position-bg",function(t){var e=t.target;u=e,m="map-position-bg",$(e).data("pageX",t.pageX),$(e).data("pageY",t.pageY),$(e).css("cursor","move"),y()}),$(document).on("mousedown",".resize",function(t){var e=t.target;u=e,m="resize",$(e).data("pageX",t.pageX),$(e).data("pageY",t.pageY),y()}),$(document).on("mouseup",function(t){"map-position-bg"===m&&x.$position.find(".map-position-bg").css("cursor","default"),m=u=null,$(b).hide()}));var t=d.data;if(t){var e=t.backgroundUrl,o=t.sketchList,n=t.textList;if(e){R(),L(e);var s=setInterval(function(){if(0!==x.$position.length){clearInterval(s);var t=o.length;if(0<t)for(var e=0;e<t;e++){z(o[e])}var i=n.length;if(0<i)for(e=0;e<i;e++){I(n[e])}}},10),i=0,r=0,a=setInterval(function(){if(0<i&&0<r){clearInterval(a);var t=1;i<r&&(t=i/r),x.setZoom(t)}else i=$(x.$container).width(),r=$(x.$container).find("img[ref=imageMaps]").width()},10)}}d.editable||function(){R(),$(x.$container).find("#kmseditors-title").hide();var n=setInterval(function(){if(0!==x.$position.length){clearInterval(n);var t=$(x.$container).find("div.map-position[dtype]"),e=x.options.onRelation||l;if(t)for(var i=0;i<t.length;i++){var o=$(t[i]);o.on("click",function(){e(x.getData($(this)))}),o.find("div.map-position-bg").css({border:"none",background:"none",cursor:"pointer"}),o.find("span.resize").css({border:"none",background:"none",display:"none"})}}},50)}()}},10)}}else f.warn("请对"+e+".init()传入必要的参数")},x.getData=function(t){var e={backgroundUrl:"",sketchList:[],textList:[]};function i(t){var e=t.context,i=t.attr("ref"),o=t.top||e.offsetTop,n=t.left||e.offsetLeft,s="number"==typeof t.width?t.width:e.offsetWidth,r="number"==typeof t.height?t.height:e.offsetHeight,a=e.innerText||"",d=t.attr("data-color")||"",c=t.attr("data-font")||"",l=t.attr("data-size")||"",p={ref:i,top:o,left:n,width:s,height:r};return a&&(p.text=a),d&&(p.color=d),c&&(p.font=c),l&&(p.size=l),p}var o=$(x.$container).find("img[ref=imageMaps]");if(0<o.length&&(e.backgroundUrl=o.attr("src")),void 0!==t)return e.sketchList=i(t),e;var n=this.$position;if(!n)return e;var s=n.find('.map-position[dtype="0"]'),r=n.find('.map-position[dtype="1"]');if(s.length<=0&&r.length<=0)return e;for(var a=[],d=[],c=n.width(),l=n.height(),p=0;p<s.length;p++){var f=(m=i($(s[p]))).left+m.width,u=m.top+m.height;f<c&&u<l&&a.push(m)}for(p=0;p<r.length;p++){var m;f=(m=i($(r[p]))).left+m.width,u=m.top+m.height;f<c&&u<l&&d.push(m)}return e.sketchList=a,e.textList=d,e},x.setLinkStatus=function(t){var e=t.ref,i=t.isLink;if(!e||"boolean"!=typeof i)return f.error("setLinkStatus传入参数有误");var o=$(x.$container).find('div.map-position[dtype="0"][ref="'+e+'"]');0!==!o.length&&(i?o.addClass("isLink"):o.removeClass("isLink"))},x.setZoom=function(t){var e=t||1;""===a&&(a=e),$(x.$container).find("#kmseditors-contant-sketch-warp").css({zoom:e,"-moz-transform":"scale("+e+")"})},x.getZoom=function(){var t=$(x.$container).find("#kmseditors-contant-sketch-warp"),e=t[0].style.zoom;if(e&&/%$/.test(e)&&(e=parseFloat(e)/100),!e){var i=t.attr("style");if(i)for(var o=i.split(";"),n=0;n<o.length;n++){var s=o[n],r=s.indexOf("scale");if(-1===r)break;e=s.substring(r+6,s.length-1);break}}return{initZoom:a,currZoom:parseFloat(e)}},x.zoomIn=function(){var t=x.getZoom().currZoom+.1,e=2*a;e<=t&&(t=e),x.setZoom(t)},x.zoomOut=function(){var t=x.getZoom().currZoom-.1,e=.6*a;t<=e&&(t=e),x.setZoom(t)},x.zoomReset=function(){x.setZoom(a)},"undefined"!=typeof module&&"object"==typeof exports?module.exports=x:"function"==typeof define&&(define.amd||define.cmd)?define(function(){return x}):t[e]=x}else f.error(e+"已经存在啦啦啦啦~");function y(){$(b).hide().find(".kmseditors-color-container").hide(),$(b).find(".kmseditors-font-container").hide()}function F(t){var e=$(t)[0].children[0],i=$(e)[0].innerText,o=$(e)[0].clientHeight,n=$(e)[0].clientWidth,s=parseInt(Math.sqrt(o*n/i.length))-8;n<s&&(s=n-5),o<s&&(s=o-5),s<0&&(s=12),$(t).attr("data-size",s).find(".map-position-bg").css({fontSize:s+"px"})}function z(t){if(0!==$(x.$container).find("img[ref=imageMaps]").length){R();var e="10",i="10",o=v,n=g,s=u++,r=!1;t&&"object"==typeof t&&(t.top&&(e=t.top),t.left&&(i=t.left),t.width&&(o=t.width),t.height&&(n=t.height),t.ref&&(s=t.ref),t.isLink&&(r=t.isLink));var a=r?" isLink":"";x.$position.append('<div ref="'+s+'" dtype="0" class="map-position'+a+'" style="top:'+e+"px;left:"+i+"px;width:"+o+"px;height:"+n+'px;"><div class="map-position-bg"></div><span class="resize"></span></div>')}else{var d="请先上传背景！";window.seajs?seajs.use("lui/dialog",function(t){t.alert(d)}):alert(d)}}function I(t){if(0!==$(x.$container).find("img[ref=imageMaps]").length){R();var e="10",i="10",o=h,n=k,s=u++,r=!1,a="#fff",d=15,c="",l="";t&&"object"==typeof t&&(t.top&&(e=t.top),t.left&&(i=t.left),t.width&&(o=t.width),t.height&&(n=t.height),t.ref&&(s=t.ref),t.isLink&&(r=t.isLink),t.color&&(a=t.color),t.text&&(c=t.text),t.font&&(l=t.font),t.size&&(d=t.size));var p='<div ref="'+s+'" dtype="1" data-color="'+a+'" data-font="'+l+'" data-size="'+d+'" class="map-position'+(r?" isLink":"")+'" style="top:'+e+"px;left:"+i+"px;width:"+o+"px;height:"+n+'px;"><div class="map-position-bg" style="color:'+a+";font-family: "+l+";font-size: "+d+'px">'+c+'</div><span class="resize"></span></div>';x.$position.append(p),t.text||(w=x.$position.find(".map-position[dtype=1]").last(),C()),$(".map-position[dtype=1]").dblclick(function(){C()}),$(".map-position[dtype=1]").on("input",function(){F($(this))})}else{var f="请先上传背景！";window.seajs?seajs.use("lui/dialog",function(t){t.alert(f)}):alert(f)}}function L(t){if(t){var e=$('<div id="kmseditors-contant-sketch-warp"></div>'),i=$('<img ref="imageMaps">'),o=$('<div class="position-conrainer"></div>'),n=!1;window.seajs&&seajs.use("lui/topic",function(t){t.subscribe("/kms/kmaps/edit/canvas",function(){if(!1===n){var t=$('[ref="imageMaps"]');x.$position&&0<x.$position.length&&(x.$position.css({width:t.width(),height:t.height()}),n=!0)}})}),i.on("load",function(t){x.$position=$(x.$container).find(".position-conrainer"),$(x.$position).off("click").on("click",function(t){if(m){var e={top:t.pageY-72,left:t.pageX};m=!1,$("#kmseditors-text").find(".kmseditors-title-btngroup-icon").removeClass("active"),I(e)}});var e=$(t.target),i=($("#kmseditors-contant"),$("#kmseditors-contant-tips"),e.width()),o=e.height();0<i&&0<o&&(n=!0),x.$position.css({top:0,left:0,width:i,height:o})}),e.append(i),e.append(o),$(x.$container).find("#kmseditors-contant").append(e),-1!==t.indexOf("?")?t+="&x=":t+="?x=",t+=(new Date).getTime(),i.attr("src",t)}}function _(){$(b).hide(),(x.options.onRelation||l)(x.getData(w))}function j(){y(),$(w).remove()}function C(){if(x.options.editable){var t,e=$(w).find(".map-position-bg");$(e).attr("contenteditable",!0).focus(),t=$(e),document.all?(t.range=document.selection.createRange(),t.range.select(),t.range.moveStart("character",-1)):(t.range=window.getSelection().getRangeAt(0),t.range.setStart(t.range.startContainer,t.context.innerText&&t.context.innerText.length)),$(e).on("blur",function(){$(e).attr("contenteditable",!1)}),y()}}function D(){$(b).find(".kmseditors-font-container").hide(),$(b).find(".kmseditors-color-container").show()}function O(){$(b).find(".kmseditors-color-container").hide(),$(b).find(".kmseditors-font-container").show()}function R(){$(x.$container).find("#kmseditors-contant-tips").hide()}}(window);