!function(e){var t="kmseditors",c=function(){},a="",s="undefined"==typeof console?{log:c,debug:c,error:c,warn:c,info:c}:console;if(s.debug||(s.debug=c),"undefined"!=typeof module&&module.exports||void 0===e[t]){var u="",p="",k={options:{},isInit:!1,$container:"",$position:""};k.init=function(a){if(a&&0!==Object.keys(a).length){if(!this.isInit){if(!a.container)return s.warn("container 不能为空");this.isInit=!0,this.$container=$("#"+a.container),(this.options=a).debug||(window.console={log:c,debug:c,error:c,warn:c,info:c}),$(function(){$(k.$container).append('<div class="kmseditors"><div id="kmseditors-title" class="kmseditors-title"><div id="kmseditors-fullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b1"></div><p>全屏</p></div><div id="kmseditors-exitfullscreen" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b5"></div><p>退出全屏</p></div><div id="kmseditors-sketch" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b2"></div><p>热点</p></div><div id="kmseditors-uploadimg" class="kmseditors-title-btngroup"><div class="kmseditors-title-btngroup-icon b4"></div><p>上传图片</p></div></div><div id="kmseditors-contant"><div id="kmseditors-contant-tips"><p>地图绘制操作指引</p><p>第一步：点击上传图片，上传制作好的地图背景</p><p>第二步：根据需求，添加热点加上关联信息</p><p>第三步：绘制完成后，点击完成，填写基本信息即可</p></div><div id="kmseditors-contextmenu"><div id="kmseditors-contextmenu-relation" class="kmseditors-contextmenu-group c1"></div><div id="kmseditors-contextmenu-color" class="kmseditors-contextmenu-group c2"></div><div id="kmseditors-contextmenu-edit" class="kmseditors-contextmenu-group c3"></div><div id="kmseditors-contextmenu-delete" class="kmseditors-contextmenu-group c4"></div></div></div></div>'),function(){if(!k.options.editable){var e=$('<div id="kmseditors-sidebar"></div>');$(k.$container).append(e),$(k.$container).css("position","relative"),e.append('<ul><li class="lui_icon_s lui_icon_s_icon_repeat mui mui-history_handler_back" title="还原" data-opt="zoomReset"></li><li class="lui_icon_s lui_icon_s_icon_zoom_in mui mui-addition" title="放大" data-opt="zoomIn"></li><li class="lui_icon_s lui_icon_s_icon_zoom_out mui mui-delete" title="缩小" data-opt="zoomOut"></li></ul>'),e.on("click",function(e){var t=$(e.target),i=t.attr("data-opt");i&&k[i]&&k[i]()})}}(),k.options.editable||$(k.$container).css({"text-align":"center"}),$("#kmseditors-contant").on("click",b);var t=$("#kmseditors-exitfullscreen");t.hide();var e,i=$("#kmseditors-fullscreen");!1===((e=document.documentElement).requestFullscreen||e.msRequestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen||!1)?i.hide():(t.on("click",function(){b(),document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),t.hide(),i.show()}),i.on("click",function(){var e;b(),(e=document.documentElement).requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),i.hide(),t.show()}));var o=$("#kmseditors-sketch");o.on("click",function(e){l()});var n=$("#kmseditors-uploadimg");n.on("click",b),function(){if("undefined"!=typeof WebUploader){var e=k.options.uploadImgUrl;if(!e)return s.error("参数uploadImgUrl 未在init方法中传入");var t=k.options.fdModelId;if(!t)return s.error("参数fdModelId 未在init方法中传入");var i=e+="&fdModelId="+t,o=WebUploader.create({auto:!0,swf:"../../lib/webuploader-0.1.5/Uploader.swf",server:i,pick:"#kmseditors-uploadimg",sendAsBinary:!0,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}});$(k.$container).find("#kmseditors-uploadimg").removeClass("webuploader-container"),$(k.$container).find("#kmseditors-uploadimg > div.webuploader-pick").removeClass("webuploader-pick"),o.on("beforeFileQueued",function(e){var t=$(k.$container).find("img[ref=imageMaps]");if(0<t.length&&!confirm("再次上传将会覆盖原来的背景图片，是否继续？"))return o.cancelFile(e);t.remove()}),o.on("uploadSuccess",function(e,t){var i=t.path||t._raw;if(!i)return s.error("_raw error",i);window.seajs&&seajs.use("lui/topic",function(e){e.publish("kms.editor.map.img.change",{fdAttId:t.fdAttId})});var o=$(k.$container).find("#kmseditors-contant-sketch-warp");o&&0<o.length&&o.remove();var n=k.options.host+i;m(n)}),o.on("uploadError",function(e){var t=$("#"+e.id),i=t.find("div.error");i.length||(i=$('<div class="error"></div>').appendTo(t)),i.text("上传失败")})}}(),u=$("#kmseditors-contextmenu"),$(u).hide(),k.options.editable&&($(u).find("#kmseditors-contextmenu-relation").on("click",r),$(u).find("#kmseditors-contextmenu-color").on("click",g),$(u).find("#kmseditors-contextmenu-edit").on("click",v),$(u).find("#kmseditors-contextmenu-delete").on("click",f))});var d=setInterval(function(){if(0!==$(k.$container).find(".kmseditors").length){var g,h;clearInterval(d),k.options.editable&&(h=g=null,$(document).on("mousemove",function(e){if(h){var t=e.pageX,i=e.pageY,o=k.$position;if(t>o.width()||i-73>o.height())h=g=null;else{var n=t-$(g).data("pageX"),s=i-$(g).data("pageY");if(0==n&&0==s)return!1;var r=$(g).parent(),a=$(r).position(),d=a.left,c=a.top;if("map-position-bg"===h){var l=d+n;l<0&&(l=0);var u=c+s;u<0&&(u=0);var p=u+r.height();p>o.height()&&(u-=p-o.height());var m=l+r.width();m>o.width()&&(l-=m-o.width()),$(r).css({left:l,top:u}),$(g).data("pageX",t),$(g).data("pageY",i)}else if("resize"===h){var l=d,u=c,f=r.height()+s;u+f>o.height()&&(f-=u+f-o.height());var v=r.width()+n;l+v>o.width()&&(v-=l+v-o.width()),f<30&&(f=30),v<50&&(v=50),$(r).css({width:v,height:f}),$(g).data("pageX",t),$(g).data("pageY",i)}}}}),$(document).on("click","#kmseditors-contant",function(e){e.preventDefault();var t=e.target,i=t.className;if("map-position-bg"===i){var o=e.pageX,n=e.pageY;(p=$(t).parent()).top=n,p.left=o,p.width=$(p).width(),p.height=$(p).height();var s=parseInt(p.attr("dtype")),r=$("#kmseditors-contextmenu-color"),a=$("#kmseditors-contextmenu-edit");0===s?(r.hide(),a.hide()):1===s&&(r.show(),a.show());var d=o,c=n,l=p[0];l&&(c=l.offsetTop+$(p).height(),d=l.offsetLeft+$(p).width()-$(u).width()),$(u).show().css({left:d,top:c})}else $(u).hide()}),$(document).on("mousedown",".map-position-bg",function(e){var t=e.target;g=t,h="map-position-bg",$(t).data("pageX",e.pageX),$(t).data("pageY",e.pageY),$(t).css("cursor","move"),$(u).hide()}),$(document).on("mousedown",".resize",function(e){var t=e.target;g=t,h="resize",$(t).data("pageX",e.pageX),$(t).data("pageY",e.pageY),$(u).hide()}),$(document).on("mouseup",function(e){"map-position-bg"===h&&k.$position.find(".map-position-bg").css("cursor","default"),h=g=null,$(u).hide()}));var e=a.data;if(e){var t=e.backgroundUrl,i=e.sketchList;if(t){b(),m(t);var o=setInterval(function(){if(0!==k.$position.length){clearInterval(o);var e=i.length;if(0<e)for(var t=0;t<e;t++){l(i[t])}}},10),n=0,s=0,r=setInterval(function(){if(0<n&&0<s){clearInterval(r);var e=1;n<s&&(e=n/s),k.setZoom(e)}else n=$(k.$container).width(),s=$(k.$container).find("img[ref=imageMaps]").width()},10)}}a.editable||function(){$(k.$container).find("#kmseditors-title").hide();var s=setInterval(function(){if(0!==k.$position.length){clearInterval(s);var e=$(k.$container).find('div.map-position[dtype="0"]'),t=k.options.onRelation||c,i=!0===k.options.debug?1:0;if(e)for(var o=0;o<e.length;o++){var n=$(e[o]);n.css({opacity:i,cursor:"pointer"}).on("click",function(){t(k.getData($(this)))})}}},10)}()}},10)}}else s.warn("请对"+t+".init()传入必要的参数")},k.getData=function(e){var t={backgroundUrl:"",sketchList:[]};function i(e){var t=e.context,i="number"==typeof e.width?e.width:t.offsetWidth,o="number"==typeof e.height?e.height:t.offsetHeight;return{ref:e.attr("ref"),top:e.top||t.offsetTop,left:e.left||t.offsetLeft,width:i,height:o}}var o=$(k.$container).find("img[ref=imageMaps]");if(0<o.length&&(t.backgroundUrl=o.attr("src")),void 0!==e)return t.sketchList=i(e),t;var n=this.$position;if(!n)return t;var s=n.find(".map-position[ref]");if(s.length<=0)return t;for(var r=[],a=0;a<s.length;a++){var d=s[a];r.push(i($(d)))}return t.sketchList=r,t},k.setLinkStatus=function(e){var t=e.ref,i=e.isLink;if(!t||"boolean"!=typeof i)return s.error("setLinkStatus传入参数有误");var o=$(k.$container).find('div.map-position[dtype="0"][ref="'+t+'"]');0!==!o.length&&(i?o.addClass("isLink"):o.removeClass("isLink"))},k.setZoom=function(e){var t=e||1;""===a&&(a=t),$(k.$container).find("#kmseditors-contant-sketch-warp").css({zoom:t,"-moz-transform":"scale("+t+")"})},k.getZoom=function(){var e=$(k.$container).find("#kmseditors-contant-sketch-warp"),t=e.css("zoom");if(t&&/%$/.test(t)&&(t=parseFloat(t)/100),!t){var i=e.attr("style");if(i)for(var o=i.split(";"),n=0;n<o.length;n++){var s=o[n],r=s.indexOf("scale");if(-1===r)break;t=s.substring(r+6,s.length-1);break}}return{initZoom:a,currZoom:parseFloat(t)}},k.zoomIn=function(){var e=k.getZoom().currZoom+.1,t=2*a;t<=e&&(e=t),k.setZoom(e)},k.zoomOut=function(){var e=k.getZoom().currZoom-.1,t=.6*a;e<=t&&(e=t),k.setZoom(e)},k.zoomReset=function(){k.setZoom(a)},"undefined"!=typeof module&&"object"==typeof exports?module.exports=k:"function"==typeof define&&(define.amd||define.cmd)?define(function(){return k}):e[t]=k}else s.error(t+"已经存在啦啦啦啦~");function l(e){if(0!==$(k.$container).find("img[ref=imageMaps]").length){b();var t="10",i="10",o="90",n="30",s=$(k.$container).find('div.map-position[dtype="0"]').length+1,r=!1;e&&"object"==typeof e&&(e.top&&(t=e.top),e.left&&(i=e.left),e.width&&(o=e.width),e.height&&(n=e.height),e.ref&&(s=e.ref),e.isLink&&(r=e.isLink));var a=r?" isLink":"";k.$position.append('<div ref="'+s+'" dtype="0" class="map-position'+a+'" style="top:'+t+"px;left:"+i+"px;width:"+o+"px;height:"+n+'px;"><div class="map-position-bg"></div><span class="resize"></span></div>')}else{var d="请先上传图片！";window.seajs?seajs.use("lui/dialog",function(e){e.alert(d)}):alert(d)}}function m(e){if(e){var t=$('<div id="kmseditors-contant-sketch-warp"></div>'),i=$('<img ref="imageMaps">'),o=$('<div class="position-conrainer"></div>');i.on("load",function(e){var t=$(e.target);k.$position=$(k.$container).find(".position-conrainer");$("#kmseditors-contant"),$("#kmseditors-contant-tips");k.$position.css({top:0,left:0,width:t.width(),height:t.height()})}),t.append(i),t.append(o),$(k.$container).find("#kmseditors-contant").append(t),-1!==e.indexOf("?")?e+="&x=":e+="?x=",e+=(new Date).getTime(),i.attr("src",e)}}function r(){$(u).hide(),(k.options.onRelation||c)(k.getData(p))}function f(){$(u).hide(),$(p).remove()}function v(){$(u).hide()}function g(){$(u).hide()}function b(){$(k.$container).find("#kmseditors-contant-tips").hide()}}(window);